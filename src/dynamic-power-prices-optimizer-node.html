<script
  type="text/javascript"
  src="resources/node-red-contrib-dyn-pwr-price-opt/setupDynamicPowerPricesOptimizer.js"
></script>

<script
  type="text/html"
  data-template-name="Dyn. Pwr. consumption optimization"
>
  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name" style="width: 240px">
  </div>
  <hr/>
  <h2>Storage</h2>
    <div class="form-row">
      <label for="node-input-storagecapacity" style="text-indent: -8px;"><i class="fa fa-clock-o"></i> Storage Capacity:</label>
      <select  id="node-input-storagecapacity" style="width: 100px">
        <option value="24">24 h</option><option value="18">18 h</option><option value="12">12 h</option><option value="6">6 h</option>
      </select>
    </div>
    <hr/>
    <h2>Schedule</h2>
  <div class="form-row">
      <label for="node-input-fromTime" style="text-indent: -8px;"><i class="fa fa-clock-o"></i> Active during <br/>[h of day]:</label>
      <select  id="node-input-fromTime" style="width: 100px">
        <option value="0">00:00</option><option value="1">01:00</option><option value="2">02:00</option><option value="3">03:00</option>
        <option value="4">04:00</option><option value="5">05:00</option><option value="6">06:00</option><option value="7">07:00</option>
        <option value="8">08:00</option><option value="9">09:00</option><option value="10">10:00</option><option value="11">11:00</option>
        <option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option>
        <option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option>
        <option value="20">20:00</option><option value="21">21:00</option><option value="22">22:00</option><option value="23">23:00</option>

      </select>
      <label for="node-input-toTime" style="width: 10px">-</label>
      <select  id="node-input-toTime" style="width: 80px"/>
        <option value="0">00:00</option><option value="1">01:00</option><option value="2">02:00</option><option value="3">03:00</option>
        <option value="4">04:00</option><option value="5">05:00</option><option value="6">06:00</option><option value="7">07:00</option>
        <option value="8">08:00</option><option value="9">09:00</option><option value="10">10:00</option><option value="11">11:00</option>
        <option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option>
        <option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option>
        <option value="20">20:00</option><option value="21">21:00</option><option value="22">22:00</option><option value="23">23:00</option>
       </select>
    </div>

    <hr/>
    <h2 class="divOutputValues">Price Ranges</h2>
    <h3 class="divOutputValues">Cheapest</h3>
   <div class="form-row">
      <label for="node-input-outputValueFirst" style="text-indent: -8px;"><i class="fa fa-arrows-h"></i> Value</label>
      <input type="text" id="node-input-outputValueFirst" style="width: 100px">
      <input type="hidden" id="node-input-outputValueFirstType">
   </div>
   <div class="form-row">
      <label for="node-input-outputValueHours" style="text-indent: -8px;"><i class="fa fa-arrows-h"></i> Number of Hours</label>   
      <select  id="node-input-outputValueHours" style="width: 100px" title="Number of hours in the range">
        <option value="0">Not fixed</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="7">7</option>
        <option value="10">10</option>
        <option value="13">13</option>
        <option value="16">16</option>
        <option value="20">20</option>
        <option value="24">24</option>
      </select>
    </div>
    <h3 class="divOutputValues">Intermediate  <button id="more-button" type="button" class=" red-ui-button red-ui-button" onclick="toggleIntermediate()" >Show</button></h3>

    <div id="intermediate" style="display:none">

      <div class="form-row" >

        <label for="node-input-outputValueSecond" style="text-indent: -8px;"><i class="fa fa-arrows-h"></i>  Intermediate 1 </label>
        <input type="text" id="node-input-outputValueSecond" style="width: 100px">
        <input type="hidden" id="node-input-outputValueSecondType">
      </div>
      <div class="form-row">
        <label for="node-input-outputValueThird" style="text-indent: -8px;"><i class="fa fa-arrows-h"></i>  Intermediate 2 </label>
        <input type="text" id="node-input-outputValueThird" style="width: 100px">
        <input type="hidden" id="node-input-outputValueThirdType">
      </div>
  </div>
  <h3 class="divOutputValues">Most Expensive</h3>
    <div class="form-row" >
    <label for="node-input-outputValueLast" style="text-indent: -8px;"><i class="fa fa-arrows-h"></i>Value</label>
    <input type="text" id="node-input-outputValueLast" style="width: 100px">
    <input type="hidden" id="node-input-outputValueLastType">
  </div>
  <div class="form-row">
    <label for="node-input-outputValueLastHours" style="text-indent: -8px;"><i class="fa fa-arrows-h"></i> Number of Hours</label>   
    <select  id="node-input-outputValueLastHours" style="width: 160px">
      <option value="0">Not fixed</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="5">5</option>
      <option value="7">7</option>
      <option value="10">10</option>
      <option value="13">13</option>
      <option value="16">16</option>
      <option value="20">20</option>
      <option value="24">24</option>
    </select>
    </div>
  </div>
 
</script>
<script type="text/html" data-help-name="Dyn. Pwr. consumption optimization">
  <p>This node splits the price data into one to four groups. Starting with the cheapest group, ending with the most expensive one.</p>
  <p>You can define an individual output value for each group. <br/>
      Depending on the price for electric power for a given time, the system assigns an output group to each hour within the defined time range. <br/> <br/>

      Every hour the output value for the group will be sent to the output.
    </p>

     <h3>Inputs</h3>
    <p>The input data must have a payload element (<b>msg.payload</b>). It can have the following optional sub elements:</p>
    <ol type="1">
      <ol>
      <li><b>Price data from electric power supplier</b><br/>
            <b>tibber</b>: Output of Tibber (<b>node-red-contrib-tibber-api</b>) node <br/>
            Example: The payload of tibber price data<br/>
                <dl class="message-properties">
                  <dt>viewer.homes[0].currentSubscription.priceInfo.today| tomorrow
                    <span class="property-type">[{&quot;total&quot;:number, &quot;startsAt&quot;: string }]</span>
                </dt>
                <dd> Array of price data<br/>
                Example: { "total": 0.2494, "startsAt": "2021-10-11T00:00:00.000+02:00" } </dd>
                </dl>
           </li>
      <li><b>others</b>:<br/>

            <dl class="message-properties">
              <dt>sources
                <span class="property-type">string</span>
            </dt>
              <dd> name of the data provider<br/>
              Example: others </dd>
            </dl>
            <dl class="message-properties">
              <dt>pricedatas
                <span class="property-type">[{"value": number, "start": number}]</span>
            </dt>
              <dd> Array of price data<br/>
              value: The price as number<br/>
              start: The hour/Date/Time as Date.getTime()</dd>
            </dl>
      </dl>

      </li>
    </ol>
      <li><b>Config</b><br/>
                Every configuration parameter can be changed at runtime by sending it within the config element.<br/>
                The following example shows a complete config input. All elements are optional:<br/>
                <dl class="message-properties">
                  <dt>outputValueFirst
                    <span class="property-type">"num"| "string" | "bool" | "json </span>
                </dt>
                  <dd> Output Value of cheapest price group</dd>
                </dl>
                <dl class="message-properties">
                  <dt class="optional">outputValueSecond
                    <span class="property-type">"num"| "string" | "bool" | "json" as string </span>
                  </dt>
                  <dd>Output Value of second price group</dd>
                </dl>
                <dl class="message-properties">
                  <dt class="optional">outputValueThird
                    <span class="property-type">"num"| "string" | "bool" | "json" as string </span>
                  </dt>
                  <dd>Output Value of third price group</dd>
                </dl>
                <dl class="message-properties">
                  <dt class="optional">outputValueLast
                    <span class="property-type">"num"| "string" | "bool" | "json" as string</span>
                  </dt>
                  <dd>Output Value of last price group</dd>
                </dl>

                <dl class="message-properties">
                  <dt>fromTime, toTime
                    <span class="property-type">"num" as string </span>
                  </dt>
                  <dd>The range of hours to be sent to output</dd>
                </dl>
                <dl class="message-properties">
                  <dt class="optional">outputValueHours
                    <span class="property-type">"num" as string </span>
                  </dt>
                  <dd>How many Prices should the cheapest price group contain?</dd>
                </dl>
                <dl class="message-properties">
                  <dt >storagecapacity
                    <span class="property-type">"num" as string </span>
                  </dt>
                  <dd>Number of hours to be considered to build all price groups. A meaningful value is maximal number of hours the device can be switched off</dd>
                </dl>
       <li><b>Time</b><br/>
            This will trigger the output. The inject node can be used to send the time.<br/>
            This input is optional. The node sends outputs every hour (when the price has changed)
        </li>
    </ol>

      <h3>Outputs</h3>
      <p>The output contains a msg.payload element with the following sub elements</p>
      <ol type="1">
          <li><b>value</b>:<br/>The node generates a schedule from the price data.<br/>
              Depending on the price for the current hour, the node will assign one of the configured groups.<br/> The node calculates the group for the current time and sends the groups output value to this element<br/>
              This element can be used to control attached devices via MQTT or other interfaces</li>
          <li><b>schedule</b>:<br/>This element contains the schedule for the calculated hour range. It can be used as input to a schedule merge node (which is not available yet)</li>
      </ol>

      <h3>Details</h3>

      <p>A typical use case for this node is optimization of power consumption for hot water generation in a tank by a heat pump.</p>

      <p>The output of each range will set the minimum tank temperature for the given price range in the heat pump.<br/>
      If the electric power is cheap, the minimum temperature is lower and the heat pump will start hot water generation also if the tank temperature is higher.<br/>
      If it's very high, the minimum temperature is the higher.<br/>
      You can press the <code>More</code> - Button to add more price ranges. They are in between lowest price range and highest price range.<br/>
      You can configure the number of hours in the cheapest price range by setting the Output Hours value.
      A meaningful value is the number of hours, a device will consume in a normal cycle.
      You can set the lowest price of the most expensive group by giving a percentage.<br/>Example: if you set 20%, the most expensive group will contain all hours with a price higher than
      maximum price - 20%.<br/>
      The rest of the hours will be distributed to the unconfigured groups which have a return value assigned.<br/>
      If all groups are unconfigured, the hours will be distributed to all groups with a return value.
      </p>

      <h4>Example:</h4>
      <table>
          <tr>
              <th>Configuration</th>
              <th>Value</th>
          </tr>
          <tr>
              <td>Group Cheapest Output Value (min temperature)</td><td>42</td>
          </tr>
          <tr>
              <td>Group Most Expensive Output Value (min temperature)</td><td>45</td>
          </tr>
      </table>
      <p>Time Ranges </p>
      <table>
          <tr>
              <th>Time Range</th>
              <th>Price Range</th>
              <th>Output Group</th>
              <th>Output Value</th>
          </tr>

          <tr><td>00:00 - 01:00 </td><td>0.25  </td><td>Price &gt;0.24 =&gt; Most Expensive </td><td>45</td></tr>

           <tr><td>01:00 - 02:00 </td><td>0.24  </td><td>Price &lt;=0.24 =&gt; Cheapest</td><td>42</td></tr>
           <tr><td>02:00 - 03:00 </td><td>0.27  </td><td>Price &gt;0.24 =&gt; Most Expensive </td><td>45</td></tr>
           <tr><td>03:00 - 04:00 </td><td>0.22  </td><td>group 1 (cheapest)</td><td>42</td></tr>
           <tr><td>04:00 - 05:00 </td><td>0.23  </td><td>group 1 (cheapest)</td><td>42</td></tr>
           <tr><td>05:00 - 06:00 </td><td>0.28  </td><td>Price &gt;0.24 =&gt; Most Expensive </td><td>45</td></tr>
      </table>
      <p>If the temperature in the tank is 43, the heatpump will start only in the Cheapest Range.</p>
      <p>If the temperature is below 42, the heatpump will also start in the Most Expensive Range.</p>
</script>
