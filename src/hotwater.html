<script>
  RED.nodes.registerType("Hotwater", {
    category: "Dynamic Prices Energy Saver",
    color: "#a6bbcf",
    defaults: {
      name: { value: "Hotwater" },
      periodlength: {
        value: 1,
        required: true,
      },
      nightstarthour: { required: false },
      nightendhour: { required: false },
      nighttargettemperature: { required: false },
      minimaltemperature: {
        value: 21,
        required: true,
      },
      maximaltemperature: {
        value: 23,
        required: true,
      },
      increasetemperatureperhour: {
        value: 0.2,
        required: true,
      },
      decreasetemperatureperhour: {
        value: 0.2,
        required: true,
      },
    },
    inputs: 1,
    outputs: 1,
    icon: "font-awesome/fa-bar-chart",
    color: "#FFCC66",
    label: function () {
      return this.name || "Hotwater";
    },
    outputLabels: ["on", "off", "schedule"],
    oneditsave: function () {},
  });
</script>
<script type="text/html" data-template-name="Hotwater">
  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name" style="width: 240px">
  </div>
  <hr/>
  <h2>Period</h2>
    <div class="form-row">
      <label for="node-input-periodlength" style="text-indent: -8px;"><i class="fa fa-clock-o"></i> Length of one Period</label>
      <select  id="node-input-periodlength" style="width: 100px">
        <option value="1">1</option><option value="0.5">1/2 h</option><option value="0.25">1/4 h</option>
      </select>
    </div>
    <hr/>
    <h2>Setback at night</h2>
  <div class="form-row">
      <label for="node-input-nightstarthour" style="text-indent: -8px;"><i class="fa fa-clock-o"></i> Active during <br/>[h of day]:</label>
      <select  id="node-input-nightstarthour" style="width: 100px">
        <option value="0">00:00</option><option value="1">01:00</option><option value="2">02:00</option><option value="3">03:00</option>
        <option value="4">04:00</option><option value="5">05:00</option><option value="6">06:00</option><option value="7">07:00</option>
        <option value="8">08:00</option><option value="9">09:00</option><option value="10">10:00</option><option value="11">11:00</option>
        <option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option>
        <option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option>
        <option value="20">20:00</option><option value="21">21:00</option><option value="22">22:00</option><option value="23">23:00</option>
      </select>
      <label for="node-input-nightendhour" style="width: 10px">-</label>
      <select  id="node-input-nightendhour" style="width: 80px"/>
        <option value="0">00:00</option><option value="1">01:00</option><option value="2">02:00</option><option value="3">03:00</option>
        <option value="4">04:00</option><option value="5">05:00</option><option value="6">06:00</option><option value="7">07:00</option>
        <option value="8">08:00</option><option value="9">09:00</option><option value="10">10:00</option><option value="11">11:00</option>
        <option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option>
        <option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option>
        <option value="20">20:00</option><option value="21">21:00</option><option value="22">22:00</option><option value="23">23:00</option>
       </select>
    </div>
    <div class="form-row">
      <label for="node-input-nighttargettemperature" style="text-indent: -8px;"><i class="fa fa-arrows-h"></i>Set  Temp.</label>
      <input type="number" id="node-input-nighttargettemperature" style="width: 100px">
    </div>
    <p>Set point  temperature at night</p>
    <hr/>
    <h2 class="divOutputValues">Hotwater Temperature Range</h2>
    <div class="form-row">
      <label for="node-input-minimaltemperature" style="text-indent: -8px;"><i class="fa fa-arrows-h"></i> Minimal:</label>
      <input type="number" id="node-input-minimaltemperature" style="width: 100px">
      <label for="node-input-maximaltemperature" style="text-indent: -8px;"><i class="fa fa-arrows-h"></i> Maximal:</label>
      <input type="number" id="node-input-maximaltemperature" style="width: 100px">
    </div>
    <p> Temperature range of set point temperature</p>
    <h2 class="divOutputValues">Cool Down and Heat Up Parameters</h2>
    <div class="form-row">
      <label for="node-input-decreasetemperatureperhour" style="text-indent: -8px;"><i class="fa fa-arrows-h"></i> Cool Down Temp[1Â°/h]</label>
      <input type="number" id="node-input-decreasetemperatureperhour" step="0.1" min="0" max="2" style="width: 100px">
    </div>
    <p>Hotwater temperature reduction per hour</p>
    <div class="form-row">
      <label for="node-input-increasetemperatureperhour" style="text-indent: -8px;"><i class="fa fa-arrows-h"></i> Heat up temp.</label>
      <input type="number" id="node-input-increasetemperatureperhour" step="0.1"  min="0" max="2"   style="width: 100px">
    </div>
    <p>Temperature increase per hour when Hotwater heating is on</p>
</script>
<script type="text/html" data-help-name="Hotwater">
    <p>
      This node Takes the current temperatures and parameters to calculate a
      prognosis of the energy consumption of the next hours. Based on that it
      adjusts the setpoint to a higher value if energy is cheap compared to later
      periods
    </p>
    <p>
      The set point will be sent as the payload in the output message. if the
      current period is cheap, the Hotwater will start heating Hotwater up to a
      maximal temperature. Otherwise will start heating Hotwater only if the
      current temperature is even below a the minimal temperature setpoint.
    </p>

    <h3>Inputs</h3>
    <p>
      The input data must have a payload element (<b>msg.payload</b>). It can have
      the following optional structure:
    </p>
    <ol type="1">
      <ol>
        <li>
          <b>Price data from electric power supplier</b><br/>
          Use this Query in <code>msg.payload</code> for the tibber-query node:<br/>
          <span style="font-family:monospace">
          {<br/> viewer {<br/>&nbsp;homes {<br/>&nbsp;&nbsp;currentSubscription{<br/>&nbsp;&nbsp;&nbsp;priceInfo{<br/>&nbsp;&nbsp;&nbsp;&nbsp;today {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total startsAt }<br/>&nbsp;&nbsp;&nbsp;&nbsp;tomorrow {<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total startsAt }<br/> } } } } }<br/>
          </span>
      <b>tibber</b>: Output of Tibber (<b>node-red-contrib-tibber-api</b>)
         node <br />
          Example: The payload of tibber price data<br />
          <dl class="message-properties">
            <dt>
              viewer.homes[0].currentSubscription.priceInfo.today| tomorrow
              <span class="property-type"
                >[{&quot;total&quot;:number, &quot;startsAt&quot;: string }]</span
              >
            </dt>
            <dd>
              Array of price data<br />
              Example: { "total": 0.2494, "startsAt":
              "2021-10-11T00:00:00.000+02:00" }
            </dd>
          </dl>
        </li>
      </ol>
      <li>
        <b>Data from Hotwater Device</b><br />
        Every configuration parameter can be changed at runtime by sending it
        within the config element.<br />
        The following example shows a complete config input. All elements are
        optional:<br />
        <dl class="message-properties">
          <dt class="optional">
            payload.currenttemperature
            <span class="property-type">"num" as string </span>
          </dt>
          <dd>Current temperature of Hotwater</dd>
        </dl>
      </li>

      <li>
        <b>Time</b><br />
        This will trigger the output. The inject node can be used to send the
        time.<br />
        This input is optional. The node sends outputs every period (when the
        price has changed)
        <dl class="message-properties">
          <dt class="optional">
            time
            <span class="property-type">"num" as string </span>
          </dt>
          <dd>Current Time to trigger output generation</dd>
        </dl>
      </li>
    </ol>

    <h3>Outputs</h3>
    <p>
      The output contains a msg.payload element containing the setpoint for the
      current state
    </p>
    <ol type="1">
      <li>
        <b>value</b>:<br />The node generates a schedule from the price data.<br />
        Depending on the price for the current hour, the node will assign one of
        the configured groups.<br />
        The node calculates the group for the current time and sends the groups
        output value to this element<br />
        This element can be used to control attached devices via MQTT or other
        interfaces
      </li>
    </ol>

  <h3>Details</h3>

    <p>
      A typical use case for this node is optimization of power consumption for
      hot water generation using an electrical heat pump.
    </p>

    <p>
      If the electric power is cheap, the setpoint is the configured maximum
      temperature. It's more likely that the heatpump starts heating. Otherwise
      and the heat pump will start hot water generation also if the tank
      temperature is higher.<br />
      If the price is high, the setpoint is the minimum temperature. The heatpump
      will start only if it's below this temperature<br />
      The following configuration parameters are available:<br/>
      <dl class="message-properties">
          <dt class="optional">
            Period: Length of one Period
            <span class="property-type">"num" as string </span>
          </dt>
          <dd>Defines the length of a time range delivered by the energy provider.
            1 hour is the default. </dd>
        </dl>
      <dl class="message-properties">
          <dt class="optional">
            Setback at night: Active during
            <span class="property-type">"num" as string </span>
          </dt>
          <dd>Defines the time range for the night. E.g. 22:00 - 05:00. Another (lower) set temperature can be specified. To prevent the heat pump from running at night</dd>
        </dl>
     <dl class="message-properties">
          <dt class="optional">
            Setback at night: Set temp.
            <span class="property-type">"num" as string </span>
          </dt>
          <dd>Set temperature during the night. A low temperature prevents the heat pump from running at night</dd>
        </dl>
    <dl class="message-properties">
          <dt class="optional">
            Room Temperature Range: Min/Max
            <span class="property-type">"num" as string </span>
          </dt>
          <dd>Minimal/maximal acceptable hot water temperature. The cost optimization happens in this temperature range.</dd>
        </dl>
    <dl class="message-properties">
          <dt class="optional">
            Cool Down and Heat Up Parameters: Cool Down Temp.
            <span class="property-type">"num" as string </span>
          </dt>
          <dd> The temperature difference the hot water temperature decrements when the heat pump is off.
            This value will be used to calculate the number of periods required for heat up hot water during the day.
          </dd>
        </dl>
    <dl class="message-properties">
          <dt class="optional">
            Cool Down and Heat Up Parameters: Heat Up Temp.
            <span class="property-type">"num" as string </span>
          </dt>
          <dd> The temperature the hot water temperature increments when the heat pump is on.
            This value will be used to calculate the number of periods required for heating during the day.
          </dd>
        </dl>
      </p>
</script>
